<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Helicopter Maintenance Dashboard</title>

  <!-- Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.10);
      --border: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.90);
      --muted: rgba(255,255,255,.65);
      --accent: #49c6ff;
      --accent2: #7c5cff;
      --good: #20c997;
      --warn: #ffb020;
      --bad: #ff4d6d;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(124,92,255,.35), transparent 55%),
        radial-gradient(900px 500px at 85% 20%, rgba(73,198,255,.30), transparent 55%),
        radial-gradient(800px 600px at 50% 95%, rgba(32,201,151,.18), transparent 55%),
        var(--bg);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 26px 18px 60px;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:18px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, rgba(73,198,255,.85), rgba(124,92,255,.85));
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.18);
    }
    .brand h1{font-size:18px; margin:0; font-weight:800; letter-spacing:.2px}
    .brand p{margin:0; color:var(--muted); font-size:12px}
    .pill{
      padding:10px 12px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; gap:10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .pill small{color:var(--muted)}
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
      display:inline-flex; align-items:center; gap:10px;
      transition:.15s transform, .15s background;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.12)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(73,198,255,.85), rgba(124,92,255,.85));
      border:1px solid rgba(255,255,255,.22);
    }
    .btn.primary:hover{background: linear-gradient(135deg, rgba(73,198,255,.95), rgba(124,92,255,.95))}
    .btn.ghost{background: transparent}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      margin-top: 14px;
    }
    .card{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .card .hd h2{
      margin:0; font-size:14px; letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }
    .card .bd{padding:16px}
    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
    }
    input::placeholder{color: rgba(255,255,255,.35)}
    .mini{
      display:grid; grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .mini .box{
      padding:12px; border-radius:14px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .mini .box strong{display:block; font-size:11px; color:var(--muted); margin-bottom:6px}
    .mini .box span{font-size:13px; font-weight:700}
    .checks{
      display:grid;
      gap:10px;
      margin-top:8px;
    }
    .check{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .check input{width:auto}
    .check i{width:18px; text-align:center; color: rgba(255,255,255,.75)}
    .footerRow{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:14px;
    }
    .note{
      margin-top:12px;
      padding:12px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size:12px;
    }

    /* Dashboard layout */
    .dashGrid{
      display:grid;
      grid-template-columns: 1.4fr .6fr;
      gap:16px;
      margin-top:16px;
    }
    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }
    .progressRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    .ring{
      display:flex; flex-direction:column; align-items:center; gap:10px;
      padding:14px;
      border-radius:18px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .ring .lbl{font-size:12px; color:var(--muted)}
    .ring .sub{font-size:12px; color:rgba(255,255,255,.75); font-weight:700}
    .ring svg{width:98px; height:98px}
    .ring .pct{font-size:18px; font-weight:900}
    .kpiRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .kpi{
      padding:12px;
      border-radius:16px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      display:flex; gap:10px; align-items:center;
    }
    .kpi .ico{
      width:36px; height:36px; border-radius:14px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
    }
    .kpi .t{font-size:11px; color:var(--muted)}
    .kpi .v{font-size:14px; font-weight:900}

    .list{
      display:grid; gap:10px;
    }
    .item{
      padding:12px;
      border-radius:16px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .item .left{display:flex; gap:10px; align-items:center}
    .badge{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.85);
      white-space:nowrap;
    }
    .badge.good{border-color: rgba(32,201,151,.35); background: rgba(32,201,151,.12)}
    .badge.warn{border-color: rgba(255,176,32,.35); background: rgba(255,176,32,.12)}
    .badge.bad{border-color: rgba(255,77,109,.35); background: rgba(255,77,109,.12)}
    .muted{color: var(--muted)}
    .hidden{display:none !important}

    /* Responsive */
    @media (max-width: 920px){
      .grid{grid-template-columns: 1fr}
      .dashGrid{grid-template-columns: 1fr}
      .progressRow{grid-template-columns: 1fr}
      .kpiRow{grid-template-columns: 1fr}
      .two{grid-template-columns: 1fr}
      .mini{grid-template-columns: 1fr}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Topbar -->
    <div class="topbar">
      <div class="brand">
        <div class="logo"><i class="fa-solid fa-helicopter" style="color:white"></i></div>
        <div>
          <h1>Helicopter Maintenance Dashboard</h1>
          <p>Work package selection • inspections • parts control</p>
        </div>
      </div>

      <div class="pill" id="statusPill">
        <i class="fa-solid fa-circle" style="color:#ffb020"></i>
        <div>
          <div style="font-weight:800; font-size:13px" id="pillTitle">Setup</div>
          <small id="pillSub">Enter aircraft data and select packages</small>
        </div>
      </div>
    </div>

    <!-- PAGE 1: SETUP -->
    <section id="pageSetup">
      <div class="grid">
        <!-- Aircraft -->
        <div class="card">
          <div class="hd">
            <h2><i class="fa-solid fa-plane-up"></i> Aircraft</h2>
            <span class="badge">AW139-ready</span>
          </div>
          <div class="bd">
            <div class="two">
              <div>
                <label>Aircraft Registration</label>
                <input id="reg" placeholder="e.g., N85AH / HZ-..." />
              </div>
              <div>
                <label>Customer / Operator (optional)</label>
                <input id="operator" placeholder="e.g., Planning Dept / Customer" />
              </div>
            </div>

            <div class="mini">
              <div class="box">
                <strong>S/N</strong>
                <input id="sn" placeholder="Serial Number" />
              </div>
              <div class="box">
                <strong>T.T (Total Time)</strong>
                <input id="tt" placeholder="e.g., 2450.3" />
              </div>
              <div class="box">
                <strong>T.C (Total Cycles)</strong>
                <input id="tc" placeholder="e.g., 1320" />
              </div>
            </div>

            <div class="note">
              <i class="fa-solid fa-lightbulb"></i>
              Tip: Keep files outside OneDrive if you process PDFs locally. (For this dashboard we store data in the browser.)
            </div>
          </div>
        </div>

        <!-- Package -->
        <div class="card">
          <div class="hd">
            <h2><i class="fa-solid fa-list-check"></i> Select Package</h2>
            <span class="badge">Planning input</span>
          </div>
          <div class="bd">
            <label>Maintenance Packages</label>
            <div class="checks">
              <div class="check">
                <input type="checkbox" id="pkg300" checked />
                <i class="fa-regular fa-clock"></i>
                <div style="flex:1">
                  <div style="font-weight:800">300 HR Aircraft</div>
                  <div class="muted" style="font-size:12px">Airframe inspections</div>
                </div>
              </div>

              <div class="check">
                <input type="checkbox" id="pkg600" />
                <i class="fa-regular fa-clock"></i>
                <div style="flex:1">
                  <div style="font-weight:800">600 HR Aircraft</div>
                  <div class="muted" style="font-size:12px">Airframe inspections</div>
                </div>
              </div>

              <div class="check">
                <input type="checkbox" id="eng300" />
                <i class="fa-solid fa-gear"></i>
                <div style="flex:1">
                  <div style="font-weight:800">300 HR Engine</div>
                  <div class="muted" style="font-size:12px">Engine routine package</div>
                </div>
              </div>

              <div class="check">
                <input type="checkbox" id="eng600" />
                <i class="fa-solid fa-gear"></i>
                <div style="flex:1">
                  <div style="font-weight:800">600 HR Engine</div>
                  <div class="muted" style="font-size:12px">Engine routine package</div>
                </div>
              </div>

              <div class="check">
                <input type="checkbox" id="routine" checked />
                <i class="fa-solid fa-clipboard-check"></i>
                <div style="flex:1">
                  <div style="font-weight:800">Routine Task Cards</div>
                  <div class="muted" style="font-size:12px">Additional routine cards</div>
                </div>
              </div>
            </div>

            <div class="footerRow">
              <button class="btn primary" id="btnStart">
                <i class="fa-solid fa-play"></i> Start Work Package
              </button>
              <button class="btn ghost" id="btnReset">
                <i class="fa-solid fa-rotate-left"></i> Reset
              </button>
            </div>

            <div class="note" id="setupHint">
              Select the tasks Planning gave you, then press <b>Start Work Package</b>.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE 2: DASHBOARD -->
    <section id="pageDash" class="hidden">
      <div class="dashGrid">
        <!-- Left: Inspections -->
        <div class="card">
          <div class="hd">
            <h2><i class="fa-solid fa-magnifying-glass"></i> Inspections</h2>
            <span class="badge" id="wpBadge">In Progress</span>
          </div>
          <div class="bd">
            <div class="kpiRow">
              <div class="kpi">
                <div class="ico"><i class="fa-solid fa-id-card-clip"></i></div>
                <div>
                  <div class="t">Aircraft</div>
                  <div class="v" id="kpiReg">—</div>
                </div>
              </div>
              <div class="kpi">
                <div class="ico"><i class="fa-solid fa-screwdriver-wrench"></i></div>
                <div>
                  <div class="t">Selected Packages</div>
                  <div class="v" id="kpiPkgs">—</div>
                </div>
              </div>
              <div class="kpi">
                <div class="ico"><i class="fa-solid fa-hourglass-half"></i></div>
                <div>
                  <div class="t">Status</div>
                  <div class="v" id="kpiStatus">In Progress</div>
                </div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="progressRow">
              <div class="ring" id="ring300">
                <div class="lbl">300 HR</div>
                <svg viewBox="0 0 120 120" aria-label="300 HR progress">
                  <circle cx="60" cy="60" r="46" stroke="rgba(255,255,255,.10)" stroke-width="12" fill="none"></circle>
                  <circle class="prog" cx="60" cy="60" r="46" stroke="url(#g1)" stroke-width="12" fill="none"
                          stroke-linecap="round" transform="rotate(-90 60 60)"></circle>
                  <defs>
                    <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                      <stop offset="0%" stop-color="#49c6ff"/>
                      <stop offset="100%" stop-color="#7c5cff"/>
                    </linearGradient>
                  </defs>
                </svg>
                <div class="pct" id="pct300">60%</div>
                <div class="sub">Aircraft</div>
              </div>

              <div class="ring" id="ring100">
                <div class="lbl">100 HR</div>
                <svg viewBox="0 0 120 120" aria-label="100 HR progress">
                  <circle cx="60" cy="60" r="46" stroke="rgba(255,255,255,.10)" stroke-width="12" fill="none"></circle>
                  <circle class="prog" cx="60" cy="60" r="46" stroke="url(#g2)" stroke-width="12" fill="none"
                          stroke-linecap="round" transform="rotate(-90 60 60)"></circle>
                  <defs>
                    <linearGradient id="g2" x1="0" y1="0" x2="1" y2="1">
                      <stop offset="0%" stop-color="#20c997"/>
                      <stop offset="100%" stop-color="#49c6ff"/>
                    </linearGradient>
                  </defs>
                </svg>
                <div class="pct" id="pct100">10%</div>
                <div class="sub">Aircraft</div>
              </div>

              <div class="ring" id="ringYear">
                <div class="lbl">1 YEAR</div>
                <svg viewBox="0 0 120 120" aria-label="1 Year progress">
                  <circle cx="60" cy="60" r="46" stroke="rgba(255,255,255,.10)" stroke-width="12" fill="none"></circle>
                  <circle class="prog" cx="60" cy="60" r="46" stroke="url(#g3)" stroke-width="12" fill="none"
                          stroke-linecap="round" transform="rotate(-90 60 60)"></circle>
                  <defs>
                    <linearGradient id="g3" x1="0" y1="0" x2="1" y2="1">
                      <stop offset="0%" stop-color="#ffb020"/>
                      <stop offset="100%" stop-color="#ff4d6d"/>
                    </linearGradient>
                  </defs>
                </svg>
                <div class="pct" id="pctYear">30%</div>
                <div class="sub">Aircraft</div>
              </div>
            </div>

            <div style="height:14px"></div>

            <div class="card" style="background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.10); box-shadow:none">
              <div class="hd" style="border-bottom:1px solid rgba(255,255,255,.10)">
                <h2><i class="fa-solid fa-triangle-exclamation"></i> Non-Routine Inspection</h2>
                <span class="badge warn">Track findings</span>
              </div>
              <div class="bd">
                <div class="two">
                  <div>
                    <label>Add a non-routine item</label>
                    <input id="nrText" placeholder="e.g., Leak found at TRGB area..." />
                  </div>
                  <div>
                    <label>Priority</label>
                    <select id="nrPri">
                      <option value="warn">Normal</option>
                      <option value="bad">Urgent</option>
                      <option value="good">Closed</option>
                    </select>
                  </div>
                </div>
                <div class="footerRow">
                  <button class="btn" id="btnAddNR"><i class="fa-solid fa-plus"></i> Add</button>
                  <button class="btn ghost" id="btnClearNR"><i class="fa-solid fa-broom"></i> Clear</button>
                </div>

                <div class="list" id="nrList" style="margin-top:12px"></div>
              </div>
            </div>

            <div class="footerRow" style="margin-top:14px">
              <button class="btn ghost" id="btnBack">
                <i class="fa-solid fa-arrow-left"></i> Back to Setup
              </button>
              <button class="btn" id="btnExport">
                <i class="fa-solid fa-file-export"></i> Export Work Package (JSON)
              </button>
            </div>

            <div class="note" id="exportNote" class="hidden"></div>
          </div>
        </div>

        <!-- Right: Parts Control -->
        <div class="split">
          <div class="card">
            <div class="hd">
              <h2><i class="fa-solid fa-boxes-stacked"></i> Parts Control</h2>
              <span class="badge">Status</span>
            </div>
            <div class="bd">
              <div class="list">
                <div class="item">
                  <div class="left">
                    <i class="fa-solid fa-bolt"></i>
                    <div>
                      <div style="font-weight:900">AOG</div>
                      <div class="muted" style="font-size:12px">Aircraft on ground parts</div>
                    </div>
                  </div>
                  <select id="partsAOG">
                    <option value="good">OK</option>
                    <option value="warn">Pending</option>
                    <option value="bad">Critical</option>
                  </select>
                </div>

                <div class="item">
                  <div class="left">
                    <i class="fa-solid fa-receipt"></i>
                    <div>
                      <div style="font-weight:900">Issued</div>
                      <div class="muted" style="font-size:12px">Items issued to job</div>
                    </div>
                  </div>
                  <select id="partsIssued">
                    <option value="good">Complete</option>
                    <option value="warn">Partial</option>
                    <option value="bad">None</option>
                  </select>
                </div>

                <div class="item">
                  <div class="left">
                    <i class="fa-solid fa-warehouse"></i>
                    <div>
                      <div style="font-weight:900">Available</div>
                      <div class="muted" style="font-size:12px">Stock availability</div>
                    </div>
                  </div>
                  <select id="partsAvail">
                    <option value="good">Available</option>
                    <option value="warn">Low Stock</option>
                    <option value="bad">Not Available</option>
                  </select>
                </div>
              </div>

              <div class="note" style="margin-top:14px">
                Update parts status anytime. It will be included in the export.
              </div>
            </div>
          </div>

          <div class="card">
            <div class="hd">
              <h2><i class="fa-solid fa-file-lines"></i> Work Package Summary</h2>
              <span class="badge" id="sumBadge">Draft</span>
            </div>
            <div class="bd">
              <div class="list" id="summaryList"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <script>
    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);

    const state = {
      aircraft: {
        reg: "",
        operator: "",
        sn: "",
        tt: "",
        tc: ""
      },
      // ===== PACKAGE TASK LIBRARY =====
const packageTasks = {
  "300HR": [
    "General visual inspection",
    "Engine bay inspection",
    "Leak check – oil & fuel",
    "Flight control lubrication",
    "Chip detector inspection"
  ],

  "600HR": [
    "Detailed fuselage inspection",
    "Transmission oil change",
    "Tail rotor inspection",
    "Avionics cooling check"
  ],

  "ENG300": [
    "Fuel nozzle inspection",
    "Engine oil filter inspection",
    "Mag plug check"
  ],

  "ENG600": [
    "Borescope inspection",
    "Fuel control check",
    "Engine mounts inspection"
  ],

  "ROUTINE": [
    "Daily lubrication",
    "Operational check",
    "Cleaning & servicing"
  ]
};
      packages: [],
      status: "Setup",
      progress: {
        "300HR": 60,
        "100HR": 10,
        "1YEAR": 30
      },
      parts: {
        aog: "good",
        issued: "good",
        avail: "good"
      },
      nonRoutine: []
    };

    const pkgMap = [
      { id: "pkg300", code: "300HR", label: "300 HR Aircraft" },
      { id: "pkg600", code: "600HR", label: "600 HR Aircraft" },
      { id: "eng300", code: "ENG300", label: "300 HR Engine" },
      { id: "eng600", code: "ENG600", label: "600 HR Engine" },
      { id: "routine", code: "ROUTINE", label: "Routine Task Cards" },
    ];

    function setPill(mode){
      const dot = document.querySelector("#statusPill i");
      if(mode === "Setup"){
        $("pillTitle").textContent = "Setup";
        $("pillSub").textContent = "Enter aircraft data and select packages";
        dot.style.color = "#ffb020";
      } else {
        $("pillTitle").textContent = "In Progress";
        $("pillSub").textContent = "Dashboard active";
        dot.style.color = "#20c997";
      }
    }

    function show(page){
      const setup = $("pageSetup");
      const dash = $("pageDash");
      if(page === "setup"){
        setup.classList.remove("hidden");
        dash.classList.add("hidden");
        setPill("Setup");
      } else {
        setup.classList.add("hidden");
        dash.classList.remove("hidden");
        setPill("Dash");
      }
    }

    function readSetup(){
      state.aircraft.reg = $("reg").value.trim();
      state.aircraft.operator = $("operator").value.trim();
      state.aircraft.sn = $("sn").value.trim();
      state.aircraft.tt = $("tt").value.trim();
      state.aircraft.tc = $("tc").value.trim();

      const selected = [];
      for(const p of pkgMap){
        if($(p.id).checked) selected.push(p);
      }
      state.packages = selected.map(x => x.code);
      state.status = "In Progress";
    }

    function updateSummary(){
      const list = $("summaryList");
      list.innerHTML = "";

      const reg = state.aircraft.reg || "—";
      const op = state.aircraft.operator || "—";
      const sn = state.aircraft.sn || "—";
      const tt = state.aircraft.tt || "—";
      const tc = state.aircraft.tc || "—";

      const items = [
        { icon: "fa-id-card-clip", title: "Registration", value: reg },
        { icon: "fa-user-gear", title: "Operator", value: op },
        { icon: "fa-barcode", title: "S/N", value: sn },
        { icon: "fa-stopwatch", title: "T.T", value: tt },
        { icon: "fa-arrows-rotate", title: "T.C", value: tc },
        { icon: "fa-list-check", title: "Packages", value: state.packages.length ? state.packages.join(", ") : "—" },
      ];

      for(const it of items){
        const row = document.createElement("div");
        row.className = "item";
        row.innerHTML = `
          <div class="left">
            <i class="fa-solid ${it.icon}"></i>
            <div>
              <div style="font-weight:900">${it.title}</div>
              <div class="muted" style="font-size:12px">${it.value}</div>
            </div>
          </div>
          <span class="badge">OK</span>
        `;
        list.appendChild(row);
      }

      $("kpiReg").textContent = reg;
      $("kpiPkgs").textContent = state.packages.length ? state.packages.length + " selected" : "—";
      $("kpiStatus").textContent = state.status;
      $("wpBadge").textContent = state.status;
      $("sumBadge").textContent = state.status === "In Progress" ? "Active" : "Draft";
    }

    function setRing(ringId, pct){
      const ring = $(ringId);
      const circle = ring.querySelector("circle.prog");
      const r = 46;
      const C = 2 * Math.PI * r;
      circle.style.strokeDasharray = `${C}`;
      circle.style.strokeDashoffset = `${C * (1 - (pct/100))}`;
    }

    function renderRings(){
      // You can later connect these to real progress values.
      setRing("ring300", state.progress["300HR"]);
      $("pct300").textContent = state.progress["300HR"] + "%";

      setRing("ring100", state.progress["100HR"]);
      $("pct100").textContent = state.progress["100HR"] + "%";

      setRing("ringYear", state.progress["1YEAR"]);
      $("pctYear").textContent = state.progress["1YEAR"] + "%";
    }

    function badgeClass(v){
      if(v === "good") return "good";
      if(v === "bad") return "bad";
      return "warn";
    }

    function syncParts(){
      state.parts.aog = $("partsAOG").value;
      state.parts.issued = $("partsIssued").value;
      state.parts.avail = $("partsAvail").value;
    }

    function renderNR(){
      const list = $("nrList");
      list.innerHTML = "";
      if(!state.nonRoutine.length){
        const empty = document.createElement("div");
        empty.className = "note";
        empty.innerHTML = `<i class="fa-regular fa-note-sticky"></i> No non-routine items yet.`;
        list.appendChild(empty);
        return;
      }

      for(let i=0;i<state.nonRoutine.length;i++){
        const it = state.nonRoutine[i];
        const row = document.createElement("div");
        row.className = "item";
        row.innerHTML = `
          <div class="left">
            <i class="fa-solid fa-wrench"></i>
            <div>
              <div style="font-weight:900">${it.text}</div>
              <div class="muted" style="font-size:12px">${new Date(it.time).toLocaleString()}</div>
            </div>
          </div>
          <div style="display:flex; gap:8px; align-items:center">
            <span class="badge ${badgeClass(it.pri)}">${it.pri.toUpperCase()}</span>
            <button class="btn ghost" data-del="${i}" title="Remove"><i class="fa-solid fa-xmark"></i></button>
          </div>
        `;
        list.appendChild(row);
      }

      list.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", () => {
          const idx = Number(btn.getAttribute("data-del"));
          state.nonRoutine.splice(idx, 1);
          renderNR();
        });
      });
    }

    function downloadJson(filename, obj){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ---------- Events ----------
    $("btnStart").addEventListener("click", () => {
      readSetup();

      if(!state.aircraft.reg){
        $("setupHint").innerHTML = `<i class="fa-solid fa-circle-exclamation"></i> Please enter <b>Aircraft Registration</b>.`;
        $("setupHint").style.borderColor = "rgba(255,77,109,.35)";
        $("setupHint").style.background = "rgba(255,77,109,.10)";
        return;
      }
      if(!state.packages.length){
        $("setupHint").innerHTML = `<i class="fa-solid fa-circle-exclamation"></i> Please select at least <b>one package</b>.`;
        $("setupHint").style.borderColor = "rgba(255,176,32,.35)";
        $("setupHint").style.background = "rgba(255,176,32,.10)";
        return;
      }

      // Reset hint styling
      $("setupHint").innerHTML = `<i class="fa-solid fa-check"></i> Work package created.`;
      $("setupHint").style.borderColor = "rgba(32,201,151,.35)";
      $("setupHint").style.background = "rgba(32,201,151,.10)";

      updateSummary();
      renderRings();
      renderNR();
      show("dash");
    });

    $("btnReset").addEventListener("click", () => {
      $("reg").value = "";
      $("operator").value = "";
      $("sn").value = "";
      $("tt").value = "";
      $("tc").value = "";
      // Keep defaults
      $("pkg300").checked = true;
      $("pkg600").checked = false;
      $("eng300").checked = false;
      $("eng600").checked = false;
      $("routine").checked = true;

      $("setupHint").innerHTML = `Select the tasks Planning gave you, then press <b>Start Work Package</b>.`;
      $("setupHint").style.borderColor = "rgba(255,255,255,.10)";
      $("setupHint").style.background = "rgba(255,255,255,.05)";
    });

    $("btnBack").addEventListener("click", () => show("setup"));

    $("btnAddNR").addEventListener("click", () => {
      const txt = $("nrText").value.trim();
      const pri = $("nrPri").value;
      if(!txt) return;
      state.nonRoutine.unshift({ text: txt, pri, time: Date.now() });
      $("nrText").value = "";
      renderNR();
    });

    $("btnClearNR").addEventListener("click", () => {
      state.nonRoutine = [];
      renderNR();
    });

    ["partsAOG","partsIssued","partsAvail"].forEach(id=>{
      $(id).addEventListener("change", () => syncParts());
    });

    $("btnExport").addEventListener("click", () => {
      syncParts();

      const exportObj = {
        aircraft: state.aircraft,
        packages: state.packages,
        status: state.status,
        inspectionsProgress: state.progress,
        parts: state.parts,
        nonRoutine: state.nonRoutine
      };

      const regSafe = (state.aircraft.reg || "aircraft").replace(/[^a-z0-9_-]/gi,"_");
      downloadJson(`${regSafe}_workpackage.json`, exportObj);
    });

    // ---------- Init ----------
    setPill("Setup");
  </script>
</body>
</html>
